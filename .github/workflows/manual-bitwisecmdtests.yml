name: Manual BitwiseCmdTests

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  run-bitwisecmdtests:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      BITWISECMD_TESTS_TOKEN: ${{ secrets.BITWISECMD_TESTS_TOKEN }}
    steps:
      - name: Ensure BitwiseCmdTests token is configured for manual runs
        if: ${{ env.BITWISECMD_TESTS_TOKEN == '' && github.event_name == 'workflow_dispatch' }}
        run: |
          echo "::error::BITWISECMD_TESTS_TOKEN secret is required to run BitwiseCmdTests manually."
          exit 1

      - name: Skip BitwiseCmdTests (token unavailable)
        if: ${{ env.BITWISECMD_TESTS_TOKEN == '' && github.event_name != 'workflow_dispatch' }}
        run: echo "Skipping BitwiseCmdTests because BITWISECMD_TESTS_TOKEN is not accessible for this event."

      - name: Checkout repository
        if: ${{ env.BITWISECMD_TESTS_TOKEN != '' }}
        uses: actions/checkout@v4

      - name: Run BitwiseCmdTests
        if: ${{ env.BITWISECMD_TESTS_TOKEN != '' }}
        uses: ./.github/actions/bitwisecmdtests
        with:
          test-command: test-prod
          upload-artifact: 'true'
          artifact-name: bitwisecmdtests-results
          bitwisecmd-tests-token: ${{ env.BITWISECMD_TESTS_TOKEN }}
